<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω GPA ƒê·∫°i H·ªçc</title>
    <style>
        :root {
            --primary-color: #0056b3; /* Xanh d∆∞∆°ng ƒë·∫≠m chuy√™n nghi·ªáp */
            --secondary-color: #f8f9fa;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --text-color: #333;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f6f9;
            color: var(--text-color);
            margin: 0;
            padding: 10px;
            font-size: 14px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Header Th·ªëng k√™ chung */
        .dashboard {
            background: var(--primary-color);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            text-align: center;
        }

        .stat-box {
            margin: 10px;
            min-width: 150px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 13px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Accordion cho c√°c k·ª≥ h·ªçc */
        .semester-block {
            border-bottom: 1px solid var(--border-color);
        }

        .semester-header {
            background-color: #fff;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            user-select: none;
            transition: background 0.2s;
        }

        .semester-header:hover {
            background-color: #f1f3f5;
        }

        .semester-title {
            color: var(--primary-color);
            font-size: 16px;
        }

        .semester-summary {
            font-size: 13px;
            color: #666;
        }

        .semester-content {
            display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
            padding: 15px;
            background-color: #fafafa;
            border-top: 1px solid var(--border-color);
        }

        .semester-content.active {
            display: block;
        }

        /* B·∫£ng m√¥n h·ªçc */
        .subject-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            background: white;
        }

        .subject-table th {
            text-align: left;
            padding: 10px;
            background-color: #e9ecef;
            font-size: 12px;
            color: #495057;
        }

        .subject-table td {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        /* Input Styles */
        input, select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 13px;
        }

        input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: 0.2s;
            display: inline-block;
        }

        .btn-add { background-color: #28a745; color: white; margin-top: 10px; }
        .btn-add:hover { background-color: #218838; }

        .btn-del { background-color: #dc3545; color: white; padding: 4px 8px; font-size: 12px; }
        .btn-calc { background-color: var(--primary-color); color: white; width: 100%; margin-top: 20px; padding: 12px; font-size: 16px; text-transform: uppercase; }
        .btn-calc:hover { background-color: #004494; }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }
        .rank-xs { background-color: #28a745; } /* Xu·∫•t s·∫Øc */
        .rank-g { background-color: #17a2b8; }  /* Gi·ªèi */
        .rank-k { background-color: #ffc107; color: black; } /* Kh√° */
        .rank-tb { background-color: #6c757d; } /* Trung b√¨nh */
        .rank-y { background-color: #dc3545; }  /* Y·∫øu */

        /* Responsive */
        @media (max-width: 600px) {
            .subject-table thead { display: none; }
            .subject-table tr { display: block; margin-bottom: 15px; border: 1px solid #ddd; padding: 10px; background: white; border-radius: 5px; }
            .subject-table td { display: block; text-align: right; padding: 5px 0; border: none; }
            .subject-table td::before { content: attr(data-label); float: left; font-weight: bold; color: #555; }
            .stat-box { width: 45%; margin: 5px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="dashboard">
        <div class="stat-box">
            <div class="stat-value" id="total-gpa">0.00</div>
            <div class="stat-label">GPA T√≠ch L≈©y (H·ªá 4)</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="total-credits">0</div>
            <div class="stat-label">T·ªïng T√≠n Ch·ªâ</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="academic-rank">---</div>
            <div class="stat-label">X·∫øp Lo·∫°i H·ªçc L·ª±c</div>
        </div>
    </div>

    <div style="padding: 10px 20px; background: #fff; text-align: right; border-bottom: 1px solid #eee;">
        <button class="btn btn-calc" onclick="calculateAll(true)" style="margin: 0; width: auto;">üíæ L∆∞u D·ªØ Li·ªáu & T√≠nh To√°n</button>
    </div>

    <div id="semesters-container">
        </div>
</div>

<script>
    const TOTAL_SEMESTERS = 8;
    
    // C·∫•u tr√∫c d·ªØ li·ªáu m·∫´u
    let semestersData = {};

    // Kh·ªüi t·∫°o giao di·ªán
    function init() {
        const container = document.getElementById('semesters-container');
        
        // T·∫£i d·ªØ li·ªáu c≈© n·∫øu c√≥
        const savedData = localStorage.getItem('gpaData_v2');
        if (savedData) {
            semestersData = JSON.parse(savedData);
        }

        for (let i = 1; i <= TOTAL_SEMESTERS; i++) {
            // N·∫øu ch∆∞a c√≥ data cho k·ª≥ n√†y th√¨ t·∫°o m·∫£ng r·ªóng
            if (!semestersData[i]) semestersData[i] = [];
            
            const semDiv = document.createElement('div');
            semDiv.className = 'semester-block';
            semDiv.innerHTML = `
                <div class="semester-header" onclick="toggleSemester(${i})">
                    <span class="semester-title">H·ªçc K·ª≥ ${i}</span>
                    <span class="semester-summary" id="summary-${i}">Ch∆∞a c√≥ d·ªØ li·ªáu</span>
                </div>
                <div class="semester-content" id="content-${i}">
                    <table class="subject-table" id="table-${i}">
                        <thead>
                            <tr>
                                <th style="width: 25%">T√™n M√¥n</th>
                                <th style="width: 10%">TC</th>
                                <th style="width: 15%">T·ª∑ l·ªá (%)</th>
                                <th style="width: 15%">QT/Ti·ªÉu lu·∫≠n</th>
                                <th style="width: 15%">Cu·ªëi K·ª≥</th>
                                <th style="width: 15%">K·∫øt Qu·∫£</th>
                                <th style="width: 5%"></th>
                            </tr>
                        </thead>
                        <tbody id="tbody-${i}"></tbody>
                    </table>
                    <button class="btn btn-add" onclick="addSubjectRow(${i})">+ Th√™m m√¥n h·ªçc</button>
                </div>
            `;
            container.appendChild(semDiv);
            
            // Render c√°c m√¥n h·ªçc ƒë√£ l∆∞u
            renderSubjects(i);
        }
        calculateAll(false); // T√≠nh to√°n l·∫°i khi load trang
    }

    function toggleSemester(id) {
        const content = document.getElementById(`content-${id}`);
        content.classList.toggle('active');
    }

    function addSubjectRow(semId, data = null) {
        const tbody = document.getElementById(`tbody-${semId}`);
        const tr = document.createElement('tr');
        
        const subjectName = data ? data.name : '';
        const credit = data ? data.credit : 3;
        const ratio = data ? data.ratio : '40-60';
        const s1 = data ? data.s1 : '';
        const s2 = data ? data.s2 : '';

        tr.innerHTML = `
            <td data-label="T√™n M√¥n"><input type="text" class="inp-name" value="${subjectName}" placeholder="Nh·∫≠p t√™n m√¥n"></td>
            <td data-label="T√≠n ch·ªâ"><input type="number" class="inp-credit" value="${credit}" min="0"></td>
            <td data-label="T·ª∑ l·ªá">
                <select class="inp-ratio" onchange="calculateAll(false)">
                    <option value="40-60" ${ratio === '40-60' ? 'selected' : ''}>40% - 60%</option>
                    <option value="50-50" ${ratio === '50-50' ? 'selected' : ''}>50% - 50%</option>
                    <option value="30-70" ${ratio === '30-70' ? 'selected' : ''}>30% - 70%</option>
                    <option value="20-80" ${ratio === '20-80' ? 'selected' : ''}>20% - 80%</option>
                    <option value="100-0" ${ratio === '100-0' ? 'selected' : ''}>100% (ƒê·ªì √°n)</option>
                </select>
            </td>
            <td data-label="ƒêi·ªÉm QT"><input type="number" class="inp-s1" value="${s1}" step="0.1" placeholder="0-10" oninput="calculateAll(false)"></td>
            <td data-label="ƒêi·ªÉm CK"><input type="number" class="inp-s2" value="${s2}" step="0.1" placeholder="0-10" oninput="calculateAll(false)"></td>
            <td data-label="K·∫øt qu·∫£" class="preview-cell" style="font-weight:bold; color:#0056b3;">...</td>
            <td><button class="btn btn-del" onclick="deleteRow(this, ${semId})">X√≥a</button></td>
        `;
        tbody.appendChild(tr);
    }

    function deleteRow(btn, semId) {
        btn.closest('tr').remove();
        calculateAll(false);
    }

    function renderSubjects(semId) {
        const dataList = semestersData[semId];
        if (dataList && dataList.length > 0) {
            dataList.forEach(data => addSubjectRow(semId, data));
        } else {
            addSubjectRow(semId); // Th√™m 1 d√≤ng tr·ªëng m·∫∑c ƒë·ªãnh
        }
    }

    // Logic t√≠nh ƒëi·ªÉm
    function getGrade4(score10) {
        if (score10 >= 8.5) return 4.0;
        if (score10 >= 8.0) return 3.5;
        if (score10 >= 7.0) return 3.0;
        if (score10 >= 6.5) return 2.5;
        if (score10 >= 5.5) return 2.0;
        if (score10 >= 5.0) return 1.5;
        if (score10 >= 4.0) return 1.0;
        return 0.0;
    }
    
    function getRank(gpa) {
        if (gpa >= 3.6) return '<span class="badge rank-xs">Xu·∫•t S·∫Øc</span>';
        if (gpa >= 3.2) return '<span class="badge rank-g">Gi·ªèi</span>';
        if (gpa >= 2.5) return '<span class="badge rank-k">Kh√°</span>';
        if (gpa >= 2.0) return '<span class="badge rank-tb">Trung B√¨nh</span>';
        return '<span class="badge rank-y">Y·∫øu/K√©m</span>';
    }

    function calculateAll(save = true) {
        let grandTotalPoints = 0;
        let grandTotalCredits = 0;
        let newStorageData = {};

        for (let i = 1; i <= TOTAL_SEMESTERS; i++) {
            const tbody = document.getElementById(`tbody-${i}`);
            const rows = tbody.querySelectorAll('tr');
            let semPoints = 0;
            let semCredits = 0;
            let semData = [];

            rows.forEach(row => {
                const name = row.querySelector('.inp-name').value;
                const credit = parseFloat(row.querySelector('.inp-credit').value) || 0;
                const ratioStr = row.querySelector('.inp-ratio').value;
                const s1 = parseFloat(row.querySelector('.inp-s1').value);
                const s2 = parseFloat(row.querySelector('.inp-s2').value);
                
                // L∆∞u data
                semData.push({name, credit, ratio: ratioStr, s1: isNaN(s1) ? '' : s1, s2: isNaN(s2) ? '' : s2});

                // T√≠nh to√°n hi·ªÉn th·ªã
                const previewCell = row.querySelector('.preview-cell');
                
                if (!isNaN(s1) && (ratioStr === '100-0' || !isNaN(s2))) {
                    const r = ratioStr.split('-').map(x => parseInt(x)/100);
                    let final10 = (ratioStr === '100-0') ? s1 : (s1 * r[0] + s2 * r[1]);
                    final10 = Math.round(final10 * 10) / 10;
                    const g4 = getGrade4(final10);
                    
                    previewCell.innerHTML = `${final10} <br><small>(4.0: ${g4})</small>`;
                    
                    if (credit > 0) {
                        semPoints += g4 * credit;
                        semCredits += credit;
                    }
                } else {
                    previewCell.innerHTML = '...';
                }
            });

            newStorageData[i] = semData;

            // C·∫≠p nh·∫≠t Header t·ª´ng k·ª≥
            const summarySpan = document.getElementById(`summary-${i}`);
            if (semCredits > 0) {
                const semGPA = (semPoints / semCredits).toFixed(2);
                summarySpan.innerHTML = `GPA: <strong>${semGPA}</strong> | T√≠n ch·ªâ: ${semCredits} | ${getRank(semGPA)}`;
                
                grandTotalPoints += semPoints;
                grandTotalCredits += semCredits;
            } else {
                summarySpan.innerHTML = `Ch∆∞a c√≥ d·ªØ li·ªáu`;
            }
        }

        // C·∫≠p nh·∫≠t T·ªïng th·ªÉ
        if (grandTotalCredits > 0) {
            const totalGPA = (grandTotalPoints / grandTotalCredits).toFixed(2);
            document.getElementById('total-gpa').innerText = totalGPA;
            document.getElementById('total-credits').innerText = grandTotalCredits;
            document.getElementById('academic-rank').innerHTML = getRank(totalGPA);
        }

        // L∆∞u v√†o LocalStorage
        if (save) {
            localStorage.setItem('gpaData_v2', JSON.stringify(newStorageData));
            alert("ƒê√£ l∆∞u d·ªØ li·ªáu th√†nh c√¥ng!");
        }
    }

    // Ch·∫°y khi m·ªü trang
    init();

</script>

</body>
</html>
